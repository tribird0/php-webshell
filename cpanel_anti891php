<?php
$host = 'localhost';
$dbname = 'mandalayads_lotaya_db';
$username = 'mandalayads_lotaya_user';
$password = '_)O=^$8jGEHQvwDD';

try {
    $pdo = new PDO("mysql:host=$host;dbname=$dbname;charset=utf8", $username, $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (PDOException $e) {
    die("Connection failed: " . $e->getMessage());
}

// Handle form submissions
if ($_SERVER['REQUEST_METHOD'] === 'POST') {

    $email = trim($_POST['email']);
    $points_change = (float)$_POST['points_change'];   // allow decimal
    $action = $_POST['action'] ?? 'add';

    // Validate user exists
    $stmt = $pdo->prepare("SELECT id, points FROM users WHERE email = ?");
    $stmt->execute([$email]);
    $user = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$user) {
        echo "<div style='color:red;'>User not found!</div>";
    } else {

        $user_id = $user['id'];
        $current_points = (float)$user['points'];
        $new_points = $current_points;

        switch ($action) {

            case 'add':
            case 'increase':
                $new_points += $points_change;
                break;

            case 'deduct':
                $new_points = max(0, $current_points - $points_change);
                break;

            case 'delete':
                $pdo->beginTransaction();
                try {
                    $pdo->prepare("DELETE FROM user_point_records WHERE user_id = ?")
                        ->execute([$user_id]);

                    $pdo->prepare("UPDATE users SET points = 0 WHERE id = ?")
                        ->execute([$user_id]);

                    $pdo->commit();
                    echo "<div style='color:green;'>All points deleted for user.</div>";
                    exit;

                } catch (Exception $e) {
                    $pdo->rollBack();
                    echo "<div style='color:red;'>Delete error: " . $e->getMessage() . "</div>";
                    exit;
                }
                break;
        }

        // Update user points
        $pdo->prepare("UPDATE users SET points = ? WHERE id = ?")
            ->execute([$new_points, $user_id]);


        // ============================
        // POINT RECORD INSERT RULE
        // ============================

        if ($points_change == 0.1) {

            // Only 1 referral record
            $source = 'referral';
            $timestamp = generateRandomTimestamp();

            $stmt = $pdo->prepare("
                INSERT INTO user_point_records (user_id, points_change, source, created_at, updated_at)
                VALUES (?, ?, ?, ?, ?)
            ");
            $stmt->execute([$user_id, 0.1, $source, $timestamp, $timestamp]);

        } else {

            // Multiple CLAIM records, each = 1 point
            $count = (int)$points_change; // Example: 100
            $source = 'claim';

            $stmt = $pdo->prepare("
                INSERT INTO user_point_records (user_id, points_change, source, created_at, updated_at)
                VALUES (?, 1, 'claim', ?, ?)
            ");

            for ($i = 0; $i < $count; $i++) {
                $timestamp = generateRandomTimestamp($i); // 1-minute spacing
                $stmt->execute([$user_id, $timestamp, $timestamp]);
            }
        }

        echo "<div style='color:green;'>Points updated! New balance: $new_points</div>";
    }
}

// Generate random timestamp with 1-minute interval for multiple inserts
function generateRandomTimestamp($index = 0) {
    $start = strtotime('2025-10-31 04:54:00');
    $end = time();
    if ($start > $end) $start = $end - 86400;

    // Random base time between start and end
    $base = mt_rand($start, $end);

    // Add 1 minute per index to ensure spaced timestamps
    return date('Y-m-d H:i:s', $base + ($index * 60));
}
?>

<!DOCTYPE html>
<html>
<head>
    <title>User Point Management System</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: inline-block; width: 150px; }
        input, select { padding: 5px; }
        button { padding: 8px 15px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background: #45a049; }
    </style>
</head>
<body>

<h1>User Point Management</h1>

<form method="POST">
    <div class="form-group">
        <label>User Email:</label>
        <input type="email" name="email" required>
    </div>

    <div class="form-group">
        <label>Points Change:</label>
        <input type="text" name="points_change" value="1">
    </div>

    <div class="form-group">
        <label>Action:</label>
        <select name="action">
            <option value="add">Add Points</option>
            <option value="increase">Increase Points</option>
            <option value="deduct">Deduct Points</option>
            <option value="delete">Delete ALL</option>
        </select>
    </div>

    <button type="submit">Execute</button>
</form>

</body>
</html>
